#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT_DIR"
DOMAINS_FILE="$ROOT_DIR/input/domains.txt"
RUNS_DIR="$ROOT_DIR/runs"
RESUME_DIR=""

log() { printf "[%s] %s\n" "$(date +"%H:%M:%S")" "$*"; }
die() { echo "ERROR: $*" >&2; exit 1; }

# Optional: load .env from recon/.env
if [[ -f "$ROOT_DIR/.env" ]]; then
  set -a
  # shellcheck disable=SC1090
  source "$ROOT_DIR/.env"
  set +a
fi

while [[ $# -gt 0 ]]; do
  case "$1" in
    -d|--domains) DOMAINS_FILE="$2"; shift 2;;
    --resume) RESUME_DIR="$2"; shift 2;;
    --enable-all) 
      ENABLE_ADDITIONAL_SOURCES=true
      ENABLE_PORT_SCAN=true
      ENABLE_TECH_DETECT=true
      ENABLE_VULN_SCAN=true
      shift
      ;;
    -h|--help)
      cat <<EOF
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    RECON - Bug Bounty Subdomain Pipeline                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Usage:
  ./bin/recon [options]

Options:
  -d, --domains FILE      Path to domains file (default: input/domains.txt)
  --resume DIR            Resume from previous run directory
  --enable-all            Enable all optional features (port scan, tech detection, vuln scan)
  -h, --help              Show this help message

Configuration:
  Edit .env file to customize:
    - DNS/HTTP concurrency and rate limits
    - Enable/disable individual features:
      ENABLE_ADDITIONAL_SOURCES=true   # Use amass, assetfinder, crt.sh, etc.
      ENABLE_PORT_SCAN=true             # Run naabu/nmap port scanning
      ENABLE_TECH_DETECT=true           # Technology detection & screenshots
      ENABLE_VULN_SCAN=true             # Run nuclei vulnerability scanner
      ENABLE_SCREENSHOTS=true           # Capture screenshots with gowitness
      ENABLE_NMAP=true                  # Run nmap service detection
      ENABLE_NIKTO=true                 # Run nikto web scanner

Core Workflow:
  1. Subdomain enumeration (subfinder + optional sources)
  2. DNS resolution (A + AAAA records)
  3. Wildcard detection (DNS + HTTP fingerprinting)
  4. HTTP probing (metadata + simhash)
  5. Asset classification (final targets + review queue)
  
Optional Phases (enable in .env):
  6. Port scanning (naabu/nmap)
  7. Technology detection (httpx, wappalyzer, wayback)
  8. Vulnerability scanning (nuclei, subjack, security headers)

Output:
  runs/<timestamp>/              Full run data
  output/                        Symlink to latest run
    â”œâ”€â”€ final.urls.txt          High-confidence targets (main output)
    â”œâ”€â”€ review.wildcards.txt    Wildcard candidates for manual review
    â”œâ”€â”€ all.assets.tsv          Full asset inventory with tags
    â”œâ”€â”€ open.ports.txt          Discovered open ports
    â”œâ”€â”€ vulns/                  Vulnerability scan results
    â”œâ”€â”€ stats.json              Run statistics and metrics
    â””â”€â”€ run.log                 Complete execution log

Examples:
  # Basic run with default settings
  ./bin/recon

  # Enable all features for comprehensive recon
  ./bin/recon --enable-all

  # Custom domains file
  ./bin/recon --domains /path/to/targets.txt

  # Resume previous run
  ./bin/recon --resume runs/2026-01-29_164718

Utilities:
  # Compare two runs
  python3 helpers/diff_runs.py --old runs/run1 --new runs/run2 -v

  # Generate statistics
  python3 helpers/generate_stats.py --outdir output/

For more information, see README.md
EOF
      exit 0
      ;;
    *) die "Unknown arg: $1";;
  esac
done

[[ -f "$DOMAINS_FILE" ]] || die "Domains file not found: $DOMAINS_FILE"

mkdir -p "$RUNS_DIR"

if [[ -n "$RESUME_DIR" ]]; then
  OUTDIR="$ROOT_DIR/$RESUME_DIR"
  [[ -d "$OUTDIR" ]] || die "Resume dir not found: $OUTDIR"
  log "Resuming run: $OUTDIR"
else
  RUN_ID="$(date +"%Y-%m-%d_%H%M%S")"
  OUTDIR="$RUNS_DIR/$RUN_ID"
  mkdir -p "$OUTDIR"
  log "Starting new run: $OUTDIR"
fi

ln -sfn "$OUTDIR" "$ROOT_DIR/output"

# Snapshot config
{
  echo "DOMAINS_FILE=$DOMAINS_FILE"
  echo "SUBFINDER_FLAGS=${SUBFINDER_FLAGS:-}"
  echo "DNS_THREADS=${DNS_THREADS:-}"
  echo "DNS_RETRY=${DNS_RETRY:-}"
  echo "DNS_RL=${DNS_RL:-}"
  echo "HTTP_THREADS=${HTTP_THREADS:-}"
  echo "HTTP_RL=${HTTP_RL:-}"
  echo "HTTP_TIMEOUT=${HTTP_TIMEOUT:-}"
  echo "WILDCARD_SAMPLES=${WILDCARD_SAMPLES:-}"
  echo "RESOLVERS_FILE=${RESOLVERS_FILE:-}"
} > "$OUTDIR/run.env"

cp -f "$DOMAINS_FILE" "$OUTDIR/domains.txt"

LOGFILE="$OUTDIR/run.log"
exec > >(tee -a "$LOGFILE") 2>&1

log "0) Bootstrap"
bash "$ROOT_DIR/scripts/00_bootstrap.sh"

log "1) Subdomain enumeration"
bash "$ROOT_DIR/scripts/01_subenum.sh" "$OUTDIR/domains.txt" "$OUTDIR"

# Optional: Additional subdomain sources
if [[ "${ENABLE_ADDITIONAL_SOURCES:-false}" == "true" ]]; then
  log "1b) Additional subdomain sources"
  bash "$ROOT_DIR/scripts/05_additional_sources.sh" "$OUTDIR/domains.txt" "$OUTDIR"
  
  # Re-resolve new subdomains
  log "1c) Re-resolving with enhanced subdomain list"
  bash "$ROOT_DIR/scripts/01_subenum.sh" "$OUTDIR/domains.txt" "$OUTDIR"
fi

# Optional: Port scanning
if [[ "${ENABLE_PORT_SCAN:-false}" == "true" ]]; then
  log "2) Port scanning"
  bash "$ROOT_DIR/scripts/02_portscan.sh" "$OUTDIR"
fi

# Optional: Technology detection
if [[ "${ENABLE_TECH_DETECT:-false}" == "true" ]]; then
  log "3) Technology detection"
  bash "$ROOT_DIR/scripts/03_techdetect.sh" "$OUTDIR"
fi

# Optional: Vulnerability scanning
if [[ "${ENABLE_VULN_SCAN:-false}" == "true" ]]; then
  log "4) Vulnerability scanning"
  bash "$ROOT_DIR/scripts/04_vulnscan.sh" "$OUTDIR"
fi

# Generate statistics
log "Generating statistics"
python3 "$ROOT_DIR/helpers/generate_stats.py" --outdir "$OUTDIR" || true

# Generate HTML report
if [[ "${ENABLE_HTML_REPORT:-true}" == "true" ]]; then
  log "Generating HTML report"
  python3 "$ROOT_DIR/helpers/generate_report.py" --outdir "$OUTDIR" || true
fi

log "Done."
log ""
log "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
log "â•‘                   RECON COMPLETE                             â•‘"
log "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
log ""
log "ğŸ“ Output directory: $OUTDIR"
log ""
log "Core Results:"
log "  â€¢ Final targets:    $OUTDIR/final.urls.txt"
log "  â€¢ Wildcard review:  $OUTDIR/review.wildcards.txt"
log "  â€¢ All assets (TSV): $OUTDIR/all.assets.tsv"
log "  â€¢ Run log:          $OUTDIR/run.log"
log ""
if [[ -f "$OUTDIR/open.ports.txt" ]]; then
  log "Port Scanning:"
  log "  â€¢ Open ports:       $OUTDIR/open.ports.txt"
  log ""
fi
if [[ -f "$OUTDIR/vulns/nuclei.jsonl" ]]; then
  log "Vulnerabilities:"
  log "  â€¢ Nuclei findings:  $OUTDIR/vulns/nuclei.jsonl"
  log "  â€¢ Summary report:   $OUTDIR/vulns/nuclei.stats.txt"
  log ""
fi
log "Statistics & Reports:"
log "  â€¢ Stats JSON:       $OUTDIR/stats.json"
log ""
